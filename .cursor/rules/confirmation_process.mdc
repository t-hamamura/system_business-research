# 確定反映処理ルール

## トリガー条件
「確定反映して」「確定版にして」「Stockに移動して」「確定保存して」のいずれかが入力された場合

## 実行手順

### ステップ1: 対象ファイル特定
1. **最新ドラフトファイルの検索**
   - Flow/直近フォルダ内のdraft_*.mdファイルを特定
   - 複数ある場合は最新の作成日時のファイルを対象
   - 対応するJSONファイルも同時に特定

2. **移動対象の確認**
   - ユーザーに移動対象ファイルを表示・確認
   - 例: 「以下のファイルを確定版に移動いたします：
     - draft_market_research.md
     - draft_market_research.json」

### ステップ2: 確定版フォルダ準備
1. **案件名の抽出**
   - ドラフトファイルのフォルダ名から案件名を取得
   - 例: Flow/202508/2025-08-16/line-marketing-tools/ → "line-marketing-tools"

2. **確定版フォルダの作成**
   ```
   Stock/projects/[案件名]/research_results/
   ```
   - フォルダが存在しない場合は新規作成
   - 案件名のスラッグ化（小文字・ハイフン区切り）

### ステップ3: ファイル移動・リネーム
1. **ファイル名の変更**
   - `draft_market_research.md` → `market_research.md`
   - `draft_competitor_analysis.md` → `competitor_analysis.md`
   - `draft_user_voice_analysis.md` → `user_voice_analysis.md`
   - `draft_integrated_research.md` → `integrated_research.md`
   - 対応するJSONファイルも同様にリネーム

2. **ファイル移動の実行**
   - Flowフォルダから確定版フォルダへの移動
   - 移動後、元のドラフトファイルは削除

### ステップ4: メタデータ更新
1. **ファイル内容の更新**
   - 調査実行日の確認・更新
   - ステータスを「確定版」に変更
   - 確定版移行日時の追記

2. **インデックスファイルの作成**
   - `Stock/projects/[案件名]/README.md`の作成または更新
   - 案件概要、調査履歴、ファイル一覧を記載

### ステップ5: バックアップ・版管理
1. **バックアップの作成**
   - 既存の確定版ファイルがある場合は日付付きでバックアップ
   - 例: `market_research_backup_20250816.md`

2. **履歴管理**
   - 調査履歴をREADME.mdに追記
   - 変更履歴の記録

### ステップ6: 完了報告
```
✅ 確定反映が完了いたしました

📁 移動先フォルダ:
Stock/projects/[案件名]/research_results/

📄 確定版ファイル:
- market_research.md
- market_research.json
- [その他のファイル]

📊 調査サマリー:
- 調査タイプ: [調査種別]
- 実行日: YYYY-MM-DD
- 情報源数: X個
- 品質スコア: XX/100

🔄 今後の作業:
- 追加調査が必要な場合は新たなトリガーキーワードで実行可能
- 確定版ファイルはStock/projects/[案件名]/でアクセス可能
```

## エラー処理

### ドラフトファイルが見つからない場合
```
❌ エラー: 確定反映できるドラフトファイルが見つかりません

以下をご確認ください：
- Flowフォルダ内にdraft_*.mdファイルが存在するか
- 調査が正常に完了しているか

まず調査を実行してからお試しください。
```

### ファイル移動エラーの場合
```
❌ エラー: ファイル移動中にエラーが発生しました

詳細: [エラー詳細]

対処方法：
1. ファイルアクセス権限を確認
2. ディスク容量を確認
3. 再度実行をお試しください
```

### 重複ファイルがある場合
```
⚠️  警告: 確定版フォルダに同名ファイルが既に存在します

対処方法：
1. 既存ファイルをバックアップとして保存
2. 新しいファイルで上書き更新
3. 確定反映を継続

続行しますか？ (Y/N)
```

## 確定版フォルダ構造
```
Stock/projects/[案件名]/
├── README.md                          # 案件概要・履歴
├── research_results/                  # 調査結果
│   ├── market_research.md            # 市場調査
│   ├── market_research.json          # 市場調査JSON
│   ├── competitor_analysis.md        # 競合調査
│   ├── competitor_analysis.json      # 競合調査JSON
│   ├── user_voice_analysis.md        # ユーザーボイス分析
│   ├── user_voice_analysis.json      # ユーザーボイス分析JSON
│   └── integrated_research.md        # 統合リサーチ
└── backups/                          # バックアップ
    ├── market_research_backup_20250815.md
    └── competitor_analysis_backup_20250810.md
```

## 品質基準
- 処理時間：30秒以内
- 成功率：95%以上
- ファイル整合性：100%保持
- メタデータ完備：必須項目すべて更新
- エラーハンドリング：適切なエラーメッセージ表示