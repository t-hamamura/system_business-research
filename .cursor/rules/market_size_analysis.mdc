# 市場規模分析ルール（v2.0: 安全機能強化版）

## 安全なファイル名変換関数
```python
import re
import unicodedata

def safe_filename(text, max_length=80):
    """
    ファイルシステムで安全な名前に変換
    """
    # NFKC正規化（全角→半角変換含む）
    text = unicodedata.normalize('NFKC', text)
    
    # 英数字、ひらがな、カタカナ、漢字、ハイフン、アンダースコアのみ許可
    safe_text = re.sub(r'[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\-]', '_', text)
    
    # 連続するアンダースコアを1つに
    safe_text = re.sub(r'_+', '_', safe_text)
    
    # 先頭末尾のアンダースコア削除
    safe_text = safe_text.strip('_')
    
    # 長さ制限
    if len(safe_text) > max_length:
        safe_text = safe_text[:max_length]
    
    # 空文字列の場合はデフォルト値
    return safe_text or "unknown"
```

## トリガー条件
「市場規模調査」「市場規模分析」「TAM SAM SOM」「市場規模算出」のいずれかが入力された場合

## 実行手順

### ステップ1: 対象確認
- ユーザーに調査対象の市場・業界を確認
- 例: 「どちらの市場の規模分析を実施いたしますか？（例：電動歯ブラシ市場）」
- 地域スコープの確認（日本、アジア、グローバル等）
- 分析期間の確認（現在、過去トレンド、将来予測）

### ステップ2: 日時フォルダ作成
現在日時を取得し、適切なフォルダ構造を作成：
```
Flow/YYYYMM/YYYY-MM-DD/[案件名]/
```

### ステップ3: 情報収集（5回のweb_search）
以下の順序で市場規模データを収集：

#### 第1段階：並列基本検索（3本同時）
1. **総市場規模**: "[対象] 市場規模 TAM 総市場 最新"
2. **成長率・予測**: "[対象] 市場成長率 CAGR 予測 最新"
3. **セグメント別**: "[対象] セグメント別 市場規模 分析 最新"

#### 第2段階：詳細データ（2本順次）
4. **地域別分析**: "[対象] 地域別 市場規模 日本 アジア 最新"
5. **調査機関データ**: "[対象] 矢野経済 富士経済 IDC 市場規模 最新"

### ステップ4: TAM/SAM/SOM分析
収集したデータを基に以下を算出：

#### TAM（Total Addressable Market）
- **定義**: 理論上の最大市場規模
- **算出方法**: 潜在顧客数 × 平均購入単価 × 購入頻度
- **データソース**: 政府統計、業界統計、人口データ

#### SAM（Serviceable Addressable Market）
- **定義**: 実際にアクセス可能な市場規模
- **算出方法**: TAM × 地理的制約 × 規制制約 × ターゲット適合率
- **考慮要因**: 競合状況、参入障壁、規制環境

#### SOM（Serviceable Obtainable Market）
- **定義**: 現実的に獲得可能な市場規模
- **算出方法**: SAM × 市場シェア予測 × 競争優位性
- **考慮要因**: 自社リソース、競争力、市場浸透戦略

### ステップ5: 成長率・トレンド分析
- **歴史的成長率**: 過去5年間のCAGR
- **将来成長予測**: 今後5年間の予測CAGR
- **成長ドライバー**: 市場拡大要因の特定
- **阻害要因**: 成長制約要因の分析

### ステップ6: セグメント分析
- **製品別セグメント**: 製品カテゴリ別の市場規模
- **価格帯別セグメント**: 価格レンジ別の市場分布
- **顧客別セグメント**: B2B/B2C、企業規模別等
- **チャネル別セグメント**: 販売チャネル別の市場規模

### ステップ7: 地域別分析
- **国内市場**: 日本市場の詳細分析
- **アジア太平洋**: 地域別の市場規模比較
- **グローバル市場**: 世界市場での位置付け
- **成長地域**: 高成長が期待される地域

### ステップ8: 信頼度評価
各情報源について：
- データの発行機関の権威性評価
- 調査手法・サンプル数の確認
- データの新しさ（直近2年以内を優先）
- 複数ソースでの数値整合性確認

### ステップ9: レポート生成
```
# 市場規模分析レポート：[対象市場名]

## 情報品質サマリー
**情報源数**: X個 | **平均発行年**: YYYY.M | **信頼度分布**: A級X個・B級X個・C級X個

## エグゼクティブサマリー
[3-4行での要約]

## 主要ファインディング
- [重要な発見事項1]
- [重要な発見事項2]
- [重要な発見事項3]

## TAM/SAM/SOM分析
### TAM（Total Addressable Market）
### SAM（Serviceable Addressable Market）
### SOM（Serviceable Obtainable Market）

## 市場成長分析
### 歴史的成長トレンド
### 将来成長予測
### 成長ドライバー分析

## セグメント別市場規模
### [セグメント1]
### [セグメント2]
### [セグメント3]

## 地域別分析
### 日本市場
### アジア太平洋市場
### グローバル市場

## 市場機会の定量化
### 短期機会（1-2年）
### 中期機会（3-5年）
### 長期機会（5年以上）

## 推奨戦略
1. [市場参入戦略]
2. [セグメント戦略]
3. [地域展開戦略]

## エビデンス一覧（自動生成）
| 主張ID | 出典名 | URL | 発行日 | 取得日 | 抜粋(<=25語) | 信頼度(A/B/C) |

---
**調査実行日**: YYYY-MM-DD  
**調査時間**: X分  
**使用モデル**: GPT（数値計算・分析に最適化）  
**検索実行回数**: X回  
**情報源数**: X個  
**品質スコア**: XX/100
```

### ステップ10: JSON出力（同時生成）
- TAM/SAM/SOM数値データ
- 成長率データ
- セグメント別数値
- 地域別数値
- 予測データ

### ステップ11: ファイル出力・完了報告
- 実行時間、ファイルパス、主要数値のサマリー報告

## 品質基準
- 実行時間：3分以内
- 情報源数：5-8個
- TAM/SAM/SOM：3項目すべて算出
- 成長率：歴史的・将来予測の両方
- セグメント分析：最低3セグメント
- 地域分析：最低2地域